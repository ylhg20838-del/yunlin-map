<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é›²æ—ç¦åˆ©æœ‰ç·šåœ°åœ–</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css">
  <style>
    body { margin: 0; }
    #map { height: 100vh; }
    #loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      text-align: center;
      font-weight: bold;
      z-index: 9999;
    }
    #filter-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 6px;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="loading">è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>
  <div id="filter-container">
    <label for="serviceFilter">ç¯©é¸æœå‹™é¡å‹ï¼š</label>
    <select id="serviceFilter">
      <option value="">å…¨éƒ¨</option>
    </select>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>

  <script>
    const map = L.map('map').setView([23.709, 120.543], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const sheetUrl = 'https://script.google.com/macros/s/AKfycbzPrDWMxp-El8NkuCQZkWBNfhU6QOw39QuLIY5MTRSJjMuppRM2_8Xv4Drmd6mqEhIeAQ/exec';
    const markerClusterGroup = L.markerClusterGroup();
    let markers = []; // å…¨éƒ¨ marker
    let allData = []; // å…¨éƒ¨è³‡æ–™

    fetch(sheetUrl)
      .then(res => res.json())
      .then(data => {
        allData = data;
        populateServiceFilter(data);
        renderMarkers(data);
        document.getElementById('loading').style.display = 'none';

        const searchControl = new L.Control.Search({
          layer: markerClusterGroup,
          propertyName: 'title',
          zoom: 16,
          initial: false,
          marker: false
        });
        map.addControl(searchControl);
      })
      .catch(error => {
        document.getElementById('loading').innerText = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        console.error('è¼‰å…¥å¤±æ•—ï¼š', error);
      });

    function renderMarkers(data) {
      markerClusterGroup.clearLayers();
      markers = [];

      data.forEach(row => {
        const { åç¨±, åœ°å€, ç·¯åº¦, ç¶“åº¦, é›»è©±, æœå‹™èªªæ˜ } = row;
        if (ç·¯åº¦ && ç¶“åº¦) {
          const marker = L.marker([parseFloat(ç·¯åº¦), parseFloat(ç¶“åº¦)], { title: åç¨± })
            .bindPopup(
              `<b>${åç¨±}</b><br>
              åœ°å€ï¼š${åœ°å€}<br>
              é›»è©±ï¼š${é›»è©± || 'ç„¡'}<br>
              æœå‹™ï¼š${æœå‹™èªªæ˜ || ''}`
            );
          markers.push(marker);
          markerClusterGroup.addLayer(marker);
        }
      });
      map.addLayer(markerClusterGroup);
    }

    function populateServiceFilter(data) {
      const select = document.getElementById('serviceFilter');
      const services = Array.from(new Set(data.map(d => d['æœå‹™èªªæ˜']).filter(Boolean))).sort();
      services.forEach(service => {
        const option = document.createElement('option');
        option.value = service;
        option.textContent = service;
        select.appendChild(option);
      });

      select.addEventListener('change', () => {
        const selected = select.value;
        if (!selected) {
          renderMarkers(allData);
        } else {
          const filtered = allData.filter(row => row['æœå‹™èªªæ˜'] === selected);
          renderMarkers(filtered);
        }
      });
    }

    function addLocationControl() {
      const locateBtn = L.control({ position: 'topleft' });
      locateBtn.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        div.style.backgroundColor = 'white';
        div.style.width = '30px';
        div.style.height = '30px';
        div.style.cursor = 'pointer';
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.justifyContent = 'center';
        div.innerHTML = 'ğŸ“';
        div.title = 'å®šä½æˆ‘ç›®å‰ä½ç½®';
        div.onclick = function() {
          map.locate({ setView: true, maxZoom: 16 });
        };
        return div;
      };
      locateBtn.addTo(map);

      map.on('locationfound', function(e) {
        L.circle(e.latlng, { radius: e.accuracy, color: 'blue', fillColor: '#30f', fillOpacity: 0.3 }).addTo(map);
      });

      map.on('locationerror', function() {
        alert('ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œè«‹ç¢ºèªç€è¦½å™¨å·²å…è¨±ä½ç½®å­˜å–ã€‚');
      });
    }

    addLocationControl();
  </script>
</body>
</html>
